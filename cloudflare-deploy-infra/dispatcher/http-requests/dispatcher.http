### Dispatcher API - HTTP Request Collection
### Install VSCode REST Client: https://marketplace.visualstudio.com/items?itemName=humao.rest-client
###
### SETUP:
### 1. Copy .env.example to .env in this directory
### 2. Fill in your auth tokens in .env
### 3. Uncomment the environment block you want to use below

# === ENVIRONMENT: Uncomment ONE block ===

# -- LOCAL --
# @baseUrl = http://localhost:8787
# @workerUrl = http://{{workerName}}.localhost:8787
# @authToken = {{$dotenv LOCAL_AUTH_TOKEN}}

# -- STAGING --
@baseUrl = https://d-staging.kiloapps.io
@workerUrl = https://{{workerName}}.d-staging.kiloapps.io
@authToken = {{$dotenv STAGING_AUTH_TOKEN}}

# -- PRODUCTION --
# @baseUrl = https://d.kiloapps.io
# @workerUrl = https://{{workerName}}.d.kiloapps.io
# @authToken = {{$dotenv PROD_AUTH_TOKEN}}

# === WORKER SETTINGS ===
@workerName = demo-app
@password = TestPassword123

###

# =============================================================================
# MANAGEMENT API (apex domain: d.kiloapps.io/api)
# =============================================================================

### Check if worker is password protected
GET {{baseUrl}}/api/password/{{workerName}}
Authorization: Bearer {{authToken}}

###

### Set password protection
PUT {{baseUrl}}/api/password/{{workerName}}
Authorization: Bearer {{authToken}}
Content-Type: application/json

{
  "password": "{{password}}"
}

###

### Remove password protection
DELETE {{baseUrl}}/api/password/{{workerName}}
Authorization: Bearer {{authToken}}

###

# =============================================================================
# WORKER AUTH (<worker>.d.kiloapps.io/__auth)
# =============================================================================

### Get login form
GET {{workerUrl}}/__auth?return=/
Accept: text/html

###

### Submit password (login)
# @name login
POST {{workerUrl}}/__auth
Content-Type: application/x-www-form-urlencoded

password={{password}}&return=/

###

### Access worker with auth cookie (paste JWT from login response)
GET {{workerUrl}}/
Cookie: kilo_auth=<paste-jwt-from-login-response>
Accept: text/html

###

# =============================================================================
# ERROR CASES & TROUBLESHOOTING
# =============================================================================

### Missing auth header (expect 401)
GET {{baseUrl}}/api/password/{{workerName}}

###

### Invalid auth token (expect 401)
GET {{baseUrl}}/api/password/{{workerName}}
Authorization: Bearer invalid-token

###

### Invalid worker name - spaces (expect 400)
GET {{baseUrl}}/api/password/invalid worker name
Authorization: Bearer {{authToken}}

###

### Wrong password (expect 401)
POST {{workerUrl}}/__auth
Content-Type: application/x-www-form-urlencoded

password=wrong-password&return=/

###

### Test rate limiting (run 6x - 6th should get 429)
POST {{workerUrl}}/__auth
Content-Type: application/x-www-form-urlencoded

password=wrong&return=/

