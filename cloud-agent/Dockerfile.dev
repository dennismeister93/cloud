FROM docker.io/cloudflare/sandbox:0.6.7

# Build arguments for metadata (all optional with defaults)
ARG BUILD_DATE=""
ARG VCS_REF=""
ARG KILOCODE_CLI_VERSION="latest"

# Build the kilo binary:
#   cd ~/projects/kilocode-backend/cloud-agent
#   ./cloud-agent-build.sh
#
# This builds kilo-cli from source and copies the linux-x64 binary here.

# Install ripgrep and Generate locales to suppress setlocale warnings
RUN apt-get update && apt-get install -y --no-install-recommends ripgrep locales && \
	   sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen && \
	   locale-gen && \
	   apt-get clean && \
	   rm -rf /var/lib/apt/lists/*
ENV LC_ALL=en_US.UTF-8
ENV LANG=en_US.UTF-8


# Install GitLab CLI (glab) - download official .deb from GitLab releases
RUN GLAB_VERSION="1.82.0" \
	&& wget -nv -O /tmp/glab.deb "https://gitlab.com/gitlab-org/cli/-/releases/v${GLAB_VERSION}/downloads/glab_${GLAB_VERSION}_linux_amd64.deb" \
	&& dpkg -i /tmp/glab.deb \
	&& rm /tmp/glab.deb

# Install pnpm globally
RUN npm install -g pnpm

RUN npm install -g pnpm @kilocode/cli@${KILOCODE_CLI_VERSION}

# === Build wrapper bundle inside container ===
# This ensures the wrapper is built with the same Bun version that will run it,
# avoiding any compatibility issues between build and runtime environments.
COPY wrapper /tmp/wrapper-build/wrapper
COPY src/shared /tmp/wrapper-build/src/shared

RUN cd /tmp/wrapper-build/wrapper && \
    bun build src/main.ts --outfile=/usr/local/bin/kilocode-wrapper.js --target=bun --minify && \
    rm -rf /tmp/wrapper-build

# DO NOT override USER, WORKDIR, or ENTRYPOINT from the base image
# The Cloudflare sandbox base image has its own startup.sh script that must run
# Installing packages globally makes them accessible regardless of the user
